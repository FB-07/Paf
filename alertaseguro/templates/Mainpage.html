{% load static %}
<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlertaSeguro</title>
    <link rel="stylesheet" href="{% static 'css/Mainstyle.css' %}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
</head>

<body>
    <div id="header">
        <a href="{% url 'mainpage' %}"><h1>AlertaSeguro</h1></a>
    </div>

    <div id="menu-hamb">
        <button id="menu-btn">☰</button>
        <div id="menu-dropdown">
            <a href="{% url 'mainpage' %}">Home</a>
            <a href="{% url 'sobre' %}">Sobre nós</a>
            <a href="{% url 'avisos' %}">Avisos</a>
            <a href="#">Notificações</a>
            {% if user.is_authenticated %}
                <p style="color:white; padding-left:15px;">
                    Olá, <b>{{ user.username }}</b>
                </p>
                <a href="{% url 'perfil' %}">Perfil</a>
            {% else %}
                <a href="{% url 'login' %}">Entrar</a>
                <a href="{% url 'registo' %}">Registar</a>
            {% endif %}
        </div>
    </div>

    <div id="menu-filtros">
    <button id="menu-btn-filtros">Filtros</button>

    <div id="menu-drop-filtros">
        <div class="dropdown-item">
        <input type="checkbox" id="toggleMunicipios">
        <label for="toggleMunicipios">Municípios</label>
        </div>

        <div class="dropdown-item">
        <input type="checkbox" id="toggleRisco0">
        <label for="toggleRisco0">Risco de incêndio hoje</label>
        </div>

        <div class="dropdown-item">
        <input type="checkbox" id="toggleRisco1">
        <label for="toggleRisco1">Risco de incêndio amanhã</label>
        </div>
    </div>
    </div>


    <div class="main">
        <div id="map"></div>
    </div>

    <footer id="footer">
        <a href="{% url 'precaucoes' %}">Precauções</a>
        <a href="{% url 'doacoes' %}">Doações</a>
    </footer>

    <script>
    // Mapa principal
      var map = L.map('map').setView([39.9, -8.0], 7);

      var OpenStreetMap_Mapnik = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      });
      OpenStreetMap_Mapnik.addTo(map);

    // API_Incidentes
    fetch("/api/incidentes/")
        .then(resp => resp.json())
        .then(lista => {
            lista.forEach(inc => {
                L.marker([inc.latitude, inc.longitude])
                    .addTo(map)
                    .bindPopup(`<b>${inc.titulo}</b><br>${inc.descricao}`);
            });
        });

    // Menu dropdown
    const menuBtn = document.getElementById("menu-btn");
    const menuDropdown = document.getElementById("menu-dropdown");

    menuBtn.addEventListener("click", () => {
        menuDropdown.classList.toggle("show");
    });

    document.addEventListener("click", (event) => {
        if (!menuBtn.contains(event.target) && !menuDropdown.contains(event.target)) {
            menuDropdown.classList.remove("show");
        }
    });

    //Menu dropdown filtros
    const menuBtnfiltros = document.getElementById("menu-btn-filtros");
    const menuDropfiltros = document.getElementById("menu-drop-filtros");

    menuBtnfiltros.addEventListener("click", () => {
        menuDropfiltros.classList.toggle("show");
    });

    document.addEventListener("click", (event) => {
        if (!menuBtnfiltros.contains(event.target) && !menuDropfiltros.contains(event.target)) {
            menuDropfiltros.classList.remove("show");
        }
    });

    // Camada dos municípios
    var municipiosLayer = L.geoJSON(null, {
        style: function(feature) {
            return {
                weight: 1,
                color: '#555',
                fillColor: feature.properties.cor || '#cccccc',
                fillOpacity: 0.7
            };
        }
    });

    fetch("{% static 'municipios.geojson' %}")
    .then(resp => resp.json())
    .then(data => {
        data.features.forEach(f => f.properties.cor = "#cccccc");
        municipiosLayer.addData(data);
    });

    // Checkbox municípios
    const checkboxMu = document.getElementById('toggleMunicipios');
    checkboxMu.addEventListener('change', () => {
        if (checkboxMu.checked) {
            municipiosLayer.addTo(map);
        } else {
            map.removeLayer(municipiosLayer);
        }
    });

    // Cores risco de incêndio
    const cores_risco = {
        1: "#00ff00",
        2: "#7fff00",
        3: "#ffff00",
        4: "#ff7f00",
        5: "#ff0000"
    };
    
    // Checkbox risco de incêndio hoje
    let municipiosData0 = null;

    fetch("{% static 'municipios.geojson' %}")
    .then(r => r.json())
    .then(data => { municipiosData0 = data; });

    var riscoHojeLayer = L.geoJSON(null, {
    style: f => ({
        weight: 1,
        color: '#555',
        fillColor: f.properties.cor || '#cccccc',
        fillOpacity: 0.7
    })
    });

    const checkboxRisco0 = document.getElementById('toggleRisco0');

    checkboxRisco0.addEventListener('change', () => {
    if (!checkboxRisco0.checked) {
        map.removeLayer(riscoHojeLayer);
        return;
    }

    fetch("/api/rcm_hoje/")
        .then(r => r.json())
        .then(rcmDict => {
        const geo = structuredClone(municipiosData0);

        geo.features.forEach(f => {
            const dico = String(f.properties.DICO).padStart(4, "0");
            const rcm = rcmDict[dico];
            f.properties.cor = cores_risco[rcm] || "#cccccc";
        });

        riscoHojeLayer.clearLayers();
        riscoHojeLayer.addData(geo);
        riscoHojeLayer.addTo(map);
        })
        .catch(err => console.error("Erro /api/rcm_hoje/", err));
    });

    // Checkbox risco de incêndio amanha

    let municipiosData1 = null;

    fetch("{% static 'municipios.geojson' %}")
    .then(r => r.json())
    .then(data => { municipiosData1 = data; });

    var riscoAmanhaLayer = L.geoJSON(null, {
    style: f => ({
        weight: 1,
        color: '#555',
        fillColor: f.properties.cor || '#cccccc',
        fillOpacity: 0.7
    })
    });

    const checkboxRisco1 = document.getElementById('toggleRisco1');

    checkboxRisco1.addEventListener('change', () => {
    if (!checkboxRisco1.checked) {
        map.removeLayer(riscoAmanhaLayer);
        return;
    }

    fetch("/api/rcm_amanha/")
        .then(r => r.json())
        .then(rcmDict => {
        const geo = structuredClone(municipiosData1);

        geo.features.forEach(f => {
            const dico = String(f.properties.DICO).padStart(4, "0");
            const rcm = rcmDict[dico];
            f.properties.cor = cores_risco[rcm] || "#cccccc";
        });

        riscoAmanhaLayer.clearLayers();
        riscoAmanhaLayer.addData(geo);
        riscoAmanhaLayer.addTo(map);
        })
        .catch(err => console.error("Erro /api/rcm_amanha/", err));
    });
    </script>
</body>
</html>
